name: Delete old container images

on:
  schedule:
    - cron: "*/5 * * * *"  # every 15 minutes @ https://crontab.guru/every-5-minutes
  workflow_dispatch:

env:
  # For merging to warmmetal
  BASE_REPOSITORY: warmmetal/csi-driver-image

  # To do extended tests via my personal repo - mbtamuli/csi-driver-image
  #BASE_REPOSITORY: mbtamuli/csi-driver-image

jobs:
  clean-ghcr:
    name: Delete old unused container images
    runs-on: ubuntu-latest
    steps:
      - uses: GitHubSecurityLab/actions-permissions/monitor@v1
        with:
          config: ${{ vars.PERMISSIONS_CONFIG }}
      - uses: actions/delete-package-versions@v4
        if: github.repository != env.BASE_REPOSITORY
        with:
          owner: ${{ github.repository_owner }}
          package-name: ${{ github.event.repository.name }}
          package-type: 'container'
          min-versions-to-keep: 1
          # https://semver.org/#is-there-a-suggested-regular-expression-regex-to-check-a-semver-string
          # Ignore any semver or 'latest'
          ignore-versions: '^(0|[1-9]\d*)\.(0|[1-9]\d*)\.(0|[1-9]\d*)(?:-((?:0|[1-9]\d*|\d*[a-zA-Z-][0-9a-zA-Z-]*)(?:\.(?:0|[1-9]\d*|\d*[a-zA-Z-][0-9a-zA-Z-]*))*))?(?:\+([0-9a-zA-Z-]+(?:\.[0-9a-zA-Z-]+)*))?|latest$'
